---
title: "Full Replication of Figure 6 from R13"
output:
  html_document:
    theme: null
    toc: false
---

```{r setup, include=FALSE}
# Load required packages
library(tidyverse)    # Data manipulation & plotting
library(readr)        # CSV import
library(patchwork)    # Combine multiple ggplots
library(broom)        # Tidy model outputs
library(zoo)          # Rolling window functions
library(lmtest)       # Durbin-Watson and Breusch-Pagan tests
library(car)          # Q-Q plot and other diagnostics
library(knitr)     # for kable()
library(kableExtra)

# Set a clean theme for all plots
theme_set(
  theme_bw(base_size = 12) +
    theme(
      panel.grid.major = element_line(color = "grey80", size = 0.2),
      panel.grid.minor = element_blank(),
      plot.title = element_text(face = "bold", hjust = 0.5),
      plot.tag = element_text(face = "bold"),
      legend.position = "none"
    )
)
```

## Data Preparation

```{r prepare-data, include=FALSE}
# Load necessary datasets
data6 <- read_csv("data6.csv")
```

## Rolling Window Estimation

```{r rolling-estimation, include=FALSE}
win    <- 40
n_win  <- nrow(data6) - win + 1

results <- map_dfr(seq_len(n_win), function(i) {
  dfw <- data6[i:(i+win-1), ]
  m   <- lm(ln_share ~ ln_Yus + ln_Qus_ch + ln_Qch + ln_Yw, data=dfw)
  ci  <- confint(m, level=0.95)
  tc  <- tidy(m)
  tibble(
    time          = dfw$time[win],
    actual_share  = dfw$ln_share[win],
    fitted_share  = predict(m,dfw)[win],
    intercept     = tc$estimate[1], intercept_low=ci[1,1], intercept_hi=ci[1,2],
    income        = tc$estimate[2], income_low   =ci[2,1], income_hi   =ci[2,2],
    price         = -tc$estimate[3], price_low  =-ci[3,2], price_hi   =-ci[3,1],
    supply        = tc$estimate[4], supply_low  =ci[4,1], supply_hi  =ci[4,2],
    world         = tc$estimate[5], world_low   =ci[5,1], world_hi   =ci[5,2]
  )
})

# Final window diagnostics
final_df <- data6[n_win:(n_win+win-1), ]
final_m  <- lm(ln_share ~ ln_Yus + ln_Qus_ch + ln_Qch + ln_Yw, data=final_df)
sum_m    <- summary(final_m)
gl_m     <- glance(final_m)
dw_p     <- dwtest(final_m)$p.value
bp_p     <- bptest(final_m)$p.value
sw_p     <- shapiro.test(residuals(final_m))$p.value

# Build diagnostics table
diag_table <- tibble(
  Statistic   = c("P-levels", "SER", "Adj. R²", "DW p-value", "BP p-value", "Shapiro p-value"),
  Value       = c(
    round(gl_m$p.value,3),
    round(sum_m$sigma,3),
    round(gl_m$adj.r.squared,3),
    round(dw_p,3),
    round(bp_p,3),
    round(sw_p,3)
  )
)

# Build coefficient & t-value table
coef_df <- broom::tidy(final_m) %>%
  filter(term != "(Intercept)") %>%
  select(term, estimate, statistic) %>%
  rename(
    Variable   = term,
    Coefficient= estimate,
    `t-value`  = statistic
  ) %>%
  bind_rows(
    tibble(
      Variable    = "Constant",
      Coefficient = coef(final_m)[1],
      `t-value`   = sum_m$coefficients[1,3]
    ),
    .
  ) %>%
  # rename log‐variable names to match paper
  mutate(
   Variable = case_when(
      Variable == "ln_Yus"    ~ "Y_us",
      Variable == "ln_Qus_ch" ~ "Q_us.ch",
      Variable == "ln_Qch"    ~ "Q^x_ch",
      Variable == "ln_Yw"     ~ "Y_w",
      TRUE                     ~ Variable
    )
  )
```

## Variables in logs in Table (f)
```{r Diagnostics (f), fig.width=12, fig.height=8}
# Display the SER, P-levels etc. as a table below the figure
diag_table %>%
  kable(booktabs=TRUE, caption="Figure 6(f) Regression Diagnostics") %>%
  kable_styling(full_width=FALSE)

coef_df %>%
  kable(
    col.names = c("Variable", "Coeff", "t-value"),
    booktabs = TRUE,
    caption = "Figure 6(f) Coefficients and t-values (variables in logs)"
  ) %>%
  kable_styling(full_width=FALSE)
```

## Plot Figure 6

```{r figure6, fig.width=14, fig.height=10}

# 1. Compute SE from the existing CIs
results2 <- results %>%
  mutate(
    intercept_se = (intercept_hi  - intercept_low ) / (2 * 1.96),
    price_se     = (price_hi      - price_low     ) / (2 * 1.96),
    supply_se    = (supply_hi     - supply_low    ) / (2 * 1.96),
    income_se    = (income_hi     - income_low    ) / (2 * 1.96),
    world_se     = (world_hi      - world_low     ) / (2 * 1.96)
  )

# 2. Panels (a)–(e): LOESS‐smoothed estimate ±2SE

# Panel (a): Intercept ±2SE, LOESS‐smoothed
p1 <- ggplot(data = results2, aes(x = time)) +
  geom_smooth(aes(y = intercept - 2*intercept_se),
              method="loess", span=0.2, se=FALSE, linetype="dashed") +
  geom_smooth(aes(y = intercept + 2*intercept_se),
              method="loess", span=0.2, se=FALSE, linetype="dashed") +
  geom_smooth(aes(y = intercept),
              method="loess", span=0.2, se=FALSE, color="black") +
  labs(tag="(a)", y="Intercept ±2SE", x=NULL)

# Panel (b): Price Elasticity ±2SE
p2 <- ggplot(data = results2, aes(x = time)) +
  geom_smooth(aes(y = price - 2*price_se),
              method="loess", span=0.2, se=FALSE, linetype="dashed") +
  geom_smooth(aes(y = price + 2*price_se),
              method="loess", span=0.2, se=FALSE, linetype="dashed") +
  geom_smooth(aes(y = price),
              method="loess", span=0.2, se=FALSE, color="#1f77b4") +
  labs(tag="(b)", y="Price Elasticity ±2SE", x=NULL)

# Panel (c): Supply Elasticity ±2SE
p3 <- ggplot(data = results2, aes(x = time)) +
  geom_smooth(aes(y = supply - 2*supply_se),
              method="loess", span=0.2, se=FALSE, linetype="dashed") +
  geom_smooth(aes(y = supply + 2*supply_se),
              method="loess", span=0.2, se=FALSE, linetype="dashed") +
  geom_smooth(aes(y = supply),
              method="loess", span=0.2, se=FALSE, color="black") +
  labs(tag="(c)", y="Supply Elasticity ±2SE", x=NULL)

# Panel (d): Income Elasticity ±2SE
p4 <- ggplot(data = results2, aes(x = time)) +
  geom_smooth(aes(y = income - 2*income_se),
              method="loess", span=0.2, se=FALSE, linetype="dashed") +
  geom_smooth(aes(y = income + 2*income_se),
              method="loess", span=0.2, se=FALSE, linetype="dashed") +
  geom_smooth(aes(y = income),
              method="loess", span=0.2, se=FALSE, color="#ff7f0e") +
  labs(tag="(d)", y="Income Elasticity ±2SE", x=NULL)

# Panel (e): World Elasticity ±2SE
p5 <- ggplot(data = results2, aes(x = time)) +
  geom_smooth(aes(y = world - 2*world_se),
              method="loess", span=0.2, se=FALSE, linetype="dashed") +
  geom_smooth(aes(y = world + 2*world_se),
              method="loess", span=0.2, se=FALSE, linetype="dashed") +
  geom_smooth(aes(y = world),
              method="loess", span=0.2, se=FALSE, color="black") +
  labs(tag="(e)", y="World Elasticity ±2SE", x="Year")

# Panel (f): Actual vs. Fitted ln_share, LOESS‐smoothed
p6 <- ggplot(data = results2, aes(x = time)) +
  geom_smooth(aes(y = actual_share),
              method="loess", span=0.2, se=FALSE, color="grey60") +
  geom_smooth(aes(y = fitted_share),
              method="loess", span=0.2, se=FALSE, color="black") +
  labs(tag="(f)", y="ln(share)", x="Year")

# Combine into 3×2 grid
(p1 | p2) /
(p3 | p4) /
(p5 | p6) +
  plot_layout(heights = c(1,1,1))

```
